name: Auto Release

on:
  push:
    branches: [main]

permissions:
  contents: write
  models: read
  pull-requests: read

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - run: npm ci

      - name: Determine version
        id: version
        run: |
          DATE=$(date -u +%Y.%m.%d)
          # Count existing tags for today to determine sequence number
          EXISTING=$(git tag -l "v${DATE}.*" | wc -l | tr -d ' ')
          SEQ=$((EXISTING + 1))
          VERSION="${DATE}.${SEQ}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "## Auto Release v$VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Stamp version
        run: echo "export const VERSION = '${{ steps.version.outputs.version }}';" > projects/shared/src/lib/version.ts

      - name: Build shared library
        run: npm run build:shared

      - name: Build elements
        run: npm run build:elements

      - name: Package release artifacts
        run: |
          cd dist
          tar -czf ../ezd-angular-${{ steps.version.outputs.version }}.tar.gz .
          cd ..
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find dist -type f -name '*.js' -o -name '*.mjs' -o -name '*.css' | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Generate AI release summary
        id: ai-summary
        continue-on-error: true
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Find previous dated release tag (exclude 'latest')
          PREV_TAG=$(git tag -l 'v[0-9]*' --sort=-v:refname | head -2 | tail -1)
          echo "Previous release tag: ${PREV_TAG:-none}"

          # Collect commits since last release
          if [ -n "$PREV_TAG" ]; then
            COMMITS=$(git log --oneline "$PREV_TAG"..HEAD 2>/dev/null || echo "")
          else
            COMMITS=$(git log --oneline -20 2>/dev/null || echo "")
          fi

          # Get merged PRs
          PR_DATA=$(gh pr list --state merged --base main --limit 20 \
            --json number,title,body \
            --jq '.[] | "PR #\(.number): \(.title)\n\(.body // "No description")\n---"' 2>/dev/null || echo "")

          if [ -z "$PR_DATA" ]; then
            PR_DATA="Commits since last release:\n$COMMITS"
          fi

          # Write PR data to temp file to avoid shell escaping issues
          echo "$PR_DATA" > /tmp/pr-data.txt
          echo "PR data collected:"
          cat /tmp/pr-data.txt | head -30

          # Call GitHub Models API to generate summary
          node -e "
            const fs = require('fs');
            const prData = fs.readFileSync('/tmp/pr-data.txt', 'utf8');

            const payload = {
              model: 'openai/gpt-4o-mini',
              messages: [{
                role: 'user',
                content: 'You are writing release notes for an Angular component library called ezd-angular. Summarize the following merged pull requests into a concise, well-formatted changelog. Use markdown with bullet points grouped by category (Features, Fixes, Improvements, CI/Infra). Keep it brief â€” 2-5 bullet points total. Do not include PR numbers.\n\nMerged PRs:\n' + prData
              }],
              max_tokens: 500
            };

            (async () => {
              try {
                const res = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                  method: 'POST',
                  headers: {
                    'Authorization': 'Bearer ' + process.env.GH_TOKEN,
                    'Content-Type': 'application/json'
                  },
                  body: JSON.stringify(payload)
                });
                const text = await res.text();
                console.error('API status:', res.status);
                console.error('API response:', text.slice(0, 500));
                const data = JSON.parse(text);
                if (data.choices && data.choices[0]) {
                  fs.writeFileSync('/tmp/ai-summary.txt', data.choices[0].message.content);
                  console.log('SUCCESS');
                } else {
                  console.error('No choices in response');
                  process.exit(1);
                }
              } catch (err) {
                console.error('API call failed:', err.message);
                process.exit(1);
              }
            })();
          " 2>&1 | tee /tmp/ai-log.txt

          if grep -q "SUCCESS" /tmp/ai-log.txt && [ -f /tmp/ai-summary.txt ]; then
            echo "AI summary generated successfully"
            cat /tmp/ai-summary.txt
            echo "has_summary=true" >> $GITHUB_OUTPUT
          else
            echo "AI summary failed, falling back to auto-generated notes"
            echo "has_summary=false" >> $GITHUB_OUTPUT
          fi

      - name: Build release body
        id: release-body
        run: |
          if [ "${{ steps.ai-summary.outputs.has_summary }}" == "true" ]; then
            {
              echo "## What's Changed"
              echo ""
              cat /tmp/ai-summary.txt
              echo ""
              echo "---"
              echo "*Release notes generated with AI via GitHub Models*"
            } > /tmp/release-body.txt
          else
            echo "Auto-release from main branch." > /tmp/release-body.txt
          fi

      - name: Create dated release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          body_path: /tmp/release-body.txt
          append_body: true
          files: ezd-angular-${{ steps.version.outputs.version }}.tar.gz

      - name: Update latest release
        run: |
          # Copy artifact with "latest" name
          cp ezd-angular-${{ steps.version.outputs.version }}.tar.gz ezd-angular-latest.tar.gz

          # Read the release body
          BODY=$(cat /tmp/release-body.txt 2>/dev/null || echo "Latest build from main")

          # Delete existing latest release if it exists
          gh release delete latest --yes 2>/dev/null || true
          git push --delete origin latest 2>/dev/null || true

          # Create new latest release pointing to same commit
          gh release create latest \
            --title "latest" \
            --notes "Latest build from main (currently ${{ steps.version.outputs.tag }})

          $BODY" \
            --target ${{ github.sha }} \
            ezd-angular-latest.tar.gz
        env:
          GH_TOKEN: ${{ github.token }}
