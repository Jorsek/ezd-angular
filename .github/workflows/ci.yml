name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci
      - name: Check formatting
        id: format
        run: npm run format:check 2>&1 | tee /tmp/format-output.txt
        continue-on-error: true
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.format.outcome }}" == "success" ]; then
            echo "## ✅ Format Check Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All files are properly formatted." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ❌ Format Check Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The following files need formatting. Run \`npm run format\` locally to fix." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat /tmp/format-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci
      - name: Run linter
        id: lint
        run: npm run lint 2>&1 | tee /tmp/lint-output.txt
        continue-on-error: true
      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.lint.outcome }}" == "success" ]; then
            WARNINGS=$(grep -c "warning" /tmp/lint-output.txt 2>/dev/null || echo "0")
            echo "## ✅ Lint Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No lint errors found." >> $GITHUB_STEP_SUMMARY
          else
            ERRORS=$(grep -c "error" /tmp/lint-output.txt 2>/dev/null || echo "?")
            echo "## ❌ Lint Failed — ${ERRORS} error(s)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 /tmp/lint-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci
      - name: Install Playwright for Vitest browser
        run: npx playwright install chromium
      - name: Run tests with coverage
        id: test
        run: npm run test:ci 2>&1 | tee /tmp/test-output.txt
        continue-on-error: true
      - name: Upload coverage data
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-output
          path: /tmp/test-output.txt
          retention-days: 1
      - name: Summary
        if: always()
        run: |
          node -e "
            const fs = require('fs');
            const raw = fs.readFileSync('/tmp/test-output.txt', 'utf8');
            const summary = process.env.GITHUB_STEP_SUMMARY;
            const outcome = '${{ steps.test.outcome }}';

            // Strip ANSI escape codes for reliable parsing
            const output = raw.replace(/\x1b\[[0-9;]*m/g, '');

            // Match Vitest summary lines: 'Tests  591 passed (591)' or 'Tests  3 failed | 588 passed (591)'
            // Only match 'Tests' lines (not 'Test Files') and take the last occurrence
            const testLines = output.match(/Tests\s+.*(?:passed|failed).*/g) || [];
            const lastLine = testLines[testLines.length - 1] || '';

            const passedMatch = lastLine.match(/(\d+)\s+passed/);
            const failedMatch = lastLine.match(/(\d+)\s+failed/);
            const passed = passedMatch ? Number(passedMatch[1]) : 0;
            const failed = failedMatch ? Number(failedMatch[1]) : 0;
            const total = passed + failed;

            // Also get test file counts
            const fileLines = output.match(/Test Files\s+.*(?:passed|failed).*/g) || [];
            const lastFileLine = fileLines[fileLines.length - 1] || '';
            const filesPassedMatch = lastFileLine.match(/(\d+)\s+passed/);
            const filesFailedMatch = lastFileLine.match(/(\d+)\s+failed/);
            const filesPassed = filesPassedMatch ? Number(filesPassedMatch[1]) : 0;
            const filesFailed = filesFailedMatch ? Number(filesFailedMatch[1]) : 0;

            if (outcome === 'success') {
              fs.appendFileSync(summary, '## ✅ Tests Passed — ' + passed + ' tests across ' + filesPassed + ' files\n\n');
            } else {
              fs.appendFileSync(summary, '## ❌ Tests Failed — ' + failed + ' of ' + total + ' tests failed (' + filesFailed + ' files)\n\n');

              // Extract failed test names
              const failLines = output.match(/FAIL .+/g) || [];
              const testFails = output.match(/×.+/g) || output.match(/✕.+/g) || [];
              if (failLines.length > 0 || testFails.length > 0) {
                fs.appendFileSync(summary, '### Failed Tests\n\n');
                for (const line of [...failLines, ...testFails].slice(0, 20)) {
                  fs.appendFileSync(summary, '- \`' + line.trim() + '\`\n');
                }
                fs.appendFileSync(summary, '\n');
              }

              fs.appendFileSync(summary, '<details><summary>Full output (last 60 lines)</summary>\n\n\`\`\`\n');
              const lines = output.split('\n');
              fs.appendFileSync(summary, lines.slice(-60).join('\n'));
              fs.appendFileSync(summary, '\n\`\`\`\n</details>\n');
            }
          "
          if [ "${{ steps.test.outcome }}" == "failure" ]; then exit 1; fi

  coverage:
    name: "Coverage ≥ 60%"
    runs-on: ubuntu-latest
    needs: [test]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: test-output
          path: /tmp
      - name: Check coverage threshold
        run: |
          node -e "
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/test-output.txt', 'utf8');
            const summary = process.env.GITHUB_STEP_SUMMARY;

            const matches = [...output.matchAll(/All files[^|]*\|\s*([\d.]+)\s*\|\s*([\d.]+)\s*\|\s*([\d.]+)\s*\|\s*([\d.]+)/g)];
            if (matches.length === 0) {
              fs.appendFileSync(summary, '## ⚠️ Coverage — could not parse\n\nNo coverage data found in test output.\n');
              process.exit(0);
            }

            const last = matches[matches.length - 1];
            const [stmts, branch, funcs, lines] = [last[1], last[2], last[3], last[4]].map(Number);
            const min = Math.min(stmts, branch, funcs, lines);
            const pass = min >= 60;

            let s = pass
              ? '## ✅ Coverage at ' + min + '%\n\n'
              : '## ❌ Coverage at ' + min + '% — below 60% threshold\n\n';

            s += '| Metric | Coverage |\n|--------|----------|\n';
            s += '| Statements | ' + stmts + '% |\n';
            s += '| Branches | ' + branch + '% |\n';
            s += '| Functions | ' + funcs + '% |\n';
            s += '| Lines | ' + lines + '% |\n';
            s += '\n**Minimum: ' + min + '%** (threshold: 60%)\n';

            fs.appendFileSync(summary, s);

            if (!pass) {
              console.log('FAIL: Coverage ' + min + '% is below 60% threshold');
              process.exit(1);
            }
            console.log('PASS: Coverage at ' + min + '%');
          "

  e2e:
    name: Storybook E2E
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium
      - name: Run Storybook E2E tests
        id: e2e
        run: npm run e2e 2>&1 | tee /tmp/e2e-output.txt
        continue-on-error: true
      - name: Summary
        if: always()
        run: |
          node -e "
            const fs = require('fs');
            const summary = process.env.GITHUB_STEP_SUMMARY;
            const outcome = '${{ steps.e2e.outcome }}';

            // Try parsing the JSON results from Playwright
            let results;
            try {
              results = JSON.parse(fs.readFileSync('/tmp/e2e-results.json', 'utf8'));
            } catch {
              // Fallback: parse text output
              const output = fs.readFileSync('/tmp/e2e-output.txt', 'utf8');
              if (outcome === 'success') {
                fs.appendFileSync(summary, '## ✅ Storybook E2E Passed\n\n');
              } else {
                fs.appendFileSync(summary, '## ❌ Storybook E2E Failed\n\n\`\`\`\n' + output.slice(-2000) + '\n\`\`\`\n');
              }
              process.exit(outcome === 'failure' ? 1 : 0);
            }

            const suites = results.suites || [];
            let passed = 0, failed = 0, skipped = 0;
            const failures = [];

            function walk(suite) {
              for (const spec of (suite.specs || [])) {
                for (const test of (spec.tests || [])) {
                  if (test.status === 'expected') passed++;
                  else if (test.status === 'unexpected') {
                    failed++;
                    failures.push({
                      title: [...(suite.title ? [suite.title] : []), spec.title].join(' > '),
                      error: (test.results?.[0]?.error?.message || '').slice(0, 200)
                    });
                  }
                  else if (test.status === 'skipped') skipped++;
                }
              }
              for (const child of (suite.suites || [])) walk(child);
            }
            for (const s of suites) walk(s);
            const total = passed + failed + skipped;

            if (outcome === 'success') {
              fs.appendFileSync(summary, '## ✅ Storybook E2E — ' + passed + ' of ' + total + ' passed\n\n');
            } else {
              fs.appendFileSync(summary, '## ❌ Storybook E2E — ' + failed + ' of ' + total + ' failed\n\n');
              if (failures.length > 0) {
                fs.appendFileSync(summary, '### Failed Tests\n\n');
                for (const f of failures) {
                  fs.appendFileSync(summary, '- **' + f.title + '**\n');
                  if (f.error) fs.appendFileSync(summary, '  \`\`\`\n  ' + f.error + '\n  \`\`\`\n');
                }
                fs.appendFileSync(summary, '\n');
              }
            }
          "
          if [ "${{ steps.e2e.outcome }}" == "failure" ]; then exit 1; fi
      - uses: actions/upload-artifact@v4
        if: steps.e2e.outcome == 'failure'
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  api-generation:
    name: API Generation (placeholder)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Placeholder
        run: |
          echo "## ℹ️ API Generation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "API client generation is not yet automated in CI." >> $GITHUB_STEP_SUMMARY
          echo "To regenerate locally, start the backend on port 8081 and run:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'npm run gen:openapi' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [format, lint, test]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm
      - run: npm ci
      - name: Build shared library
        id: build-shared
        run: npm run build:shared 2>&1 | tee /tmp/build-output.txt
        continue-on-error: true
      - name: Build elements
        id: build-elements
        if: steps.build-shared.outcome == 'success'
        run: npm run build:elements 2>&1 | tee -a /tmp/build-output.txt
        continue-on-error: true
      - name: Summary
        if: always()
        run: |
          SHARED="${{ steps.build-shared.outcome }}"
          ELEMENTS="${{ steps.build-elements.outcome }}"

          if [ "$SHARED" == "success" ] && [ "$ELEMENTS" == "success" ]; then
            SIZE=$(du -sh dist/ 2>/dev/null | cut -f1 || echo "?")
            JS_COUNT=$(find dist/ -name '*.js' -o -name '*.mjs' 2>/dev/null | wc -l | tr -d ' ')
            echo "## ✅ Build Passed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| | |" >> $GITHUB_STEP_SUMMARY
            echo "|---|---|" >> $GITHUB_STEP_SUMMARY
            echo "| Output size | ${SIZE} |" >> $GITHUB_STEP_SUMMARY
            echo "| JS bundles | ${JS_COUNT} |" >> $GITHUB_STEP_SUMMARY
          else
            FAILED_STEP=""
            if [ "$SHARED" == "failure" ]; then FAILED_STEP="shared library"; fi
            if [ "$ELEMENTS" == "failure" ]; then FAILED_STEP="elements"; fi
            echo "## ❌ Build Failed — ${FAILED_STEP}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Extract TS errors
            ERRORS=$(grep -E "^(ERROR|error TS)" /tmp/build-output.txt 2>/dev/null | head -20)
            if [ -n "$ERRORS" ]; then
              echo "### Errors" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
              echo "$ERRORS" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Full output (last 60 lines)</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -60 /tmp/build-output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
      - name: Upload build artifacts
        if: steps.build-elements.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: build-output
          path: dist/
          retention-days: 7
