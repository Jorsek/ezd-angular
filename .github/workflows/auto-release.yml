name: Auto Release

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: npm

      - run: npm ci

      - name: Determine version
        id: version
        run: |
          DATE=$(date -u +%Y-%m-%d)
          # Count existing tags for today to determine sequence number
          EXISTING=$(git tag -l "v${DATE}-*" | wc -l | tr -d ' ')
          SEQ=$((EXISTING + 1))
          VERSION="${DATE}-${SEQ}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "## Auto Release v$VERSION" >> $GITHUB_STEP_SUMMARY

      - name: Build shared library
        run: npm run build:shared

      - name: Build elements
        run: npm run build:elements

      - name: Package release artifacts
        run: |
          cd dist
          tar -czf ../ezd-angular-${{ steps.version.outputs.version }}.tar.gz .
          cd ..
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          find dist -type f -name '*.js' -o -name '*.mjs' -o -name '*.css' | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Create dated release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          generate_release_notes: true
          files: ezd-angular-${{ steps.version.outputs.version }}.tar.gz

      - name: Update latest release
        run: |
          # Copy artifact with "latest" name
          cp ezd-angular-${{ steps.version.outputs.version }}.tar.gz ezd-angular-latest.tar.gz

          # Delete existing latest release if it exists
          gh release delete latest --yes 2>/dev/null || true
          git push --delete origin latest 2>/dev/null || true

          # Create new latest release pointing to same commit
          gh release create latest \
            --title "latest" \
            --notes "Latest build from main (currently ${{ steps.version.outputs.tag }})" \
            --target ${{ github.sha }} \
            ezd-angular-latest.tar.gz
        env:
          GH_TOKEN: ${{ github.token }}
